# Тестовое задание: Система чатов

Ruby on Rails 8.1 приложение - основа для выполнения тестового задания.

## Запуск проекта

### Вариант 1: Локально (SQLite)

Требуется Ruby 3.3.5. SQLite используется по умолчанию.

```bash
bundle install
bundle exec rails db:prepare
bin/dev
```

Открыть <http://localhost:3000>

### Вариант 2: Dev Container (PostgreSQL)

Не требует локальной установки Ruby. Использует PostgreSQL. Работает с VS Code или GitHub Codespaces.

1. Установить [Docker](https://www.docker.com/products/docker-desktop) и [VS Code](https://code.visualstudio.com/)
2. Установить расширение [Dev Containers](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers)
3. Открыть папку проекта в VS Code
4. Нажать "Reopen in Container" (или выполнить команду `Dev Containers: Reopen in Container`)
5. Дождаться сборки контейнера и установки зависимостей
6. Выполнить `bin/dev`
7. Открыть <http://localhost:3000>

### Вариант 3: Локально с PostgreSQL

```bash
export DATABASE_URL=postgres://postgres:postgres@localhost/rails_chat_development

bundle install
bundle exec rails db:prepare
bin/dev
```

## Тестовые аккаунты

Пароль не требуется - достаточно ввести никнейм:

- **Админ:** `admin`
- **Пользователи:** `alice`, `bob`, `charlie`, `diana`, `eve`

---

## Тестовое задание

### Цель

Разработать **гибкую систему чатов**, вдохновлённую [Twilio Conversations API](https://www.twilio.com/docs/conversations). Система должна быть достаточно универсальной, чтобы поддерживать различные сценарии использования.

---

### Требования к системе

Это требования к архитектуре системы чатов. Система должна поддерживать эти возможности, чтобы на её основе можно было реализовать конкретные бизнес-сценарии.

#### Разговоры (Conversations)

- Разговор может иметь **произвольное количество участников**
- Участники могут присоединяться и покидать разговор
- Разговоры могут создаваться **пользователями** или **системой** (приложение создаёт чат и добавляет участников)

#### Сообщения

- Текстовые сообщения от участников
- **Системные сообщения** — отправляются от имени системы, без привязки к участнику (например: "Alice присоединилась к чату")
- **Произвольные атрибуты** — возможность хранить дополнительные данные в сообщении (JSON)
- Подготовить структуру для вложений (реализация загрузки файлов не требуется)

#### Участники

- **Произвольные атрибуты** — возможность хранить дополнительные данные об участнике (аватар, роль, статус и т.д.)
- Отображаемое имя участника в контексте разговора

#### Статус прочтения

- Отметка сообщений как прочитанных
- Подсчёт непрочитанных сообщений для каждого участника
- Индикация непрочитанных в списке чатов

#### Real-time

- Новые сообщения появляются без перезагрузки страницы (Action Cable / Turbo Streams)
- Обновление счётчика непрочитанных в реальном времени

#### Гибкость

Архитектура должна позволять **без изменения ядра системы** реализовать:

- **Ограничение 1-on-1** — разговоры только между двумя участниками
- **Контроль доступа** — кто может создавать разговоры, кто может присоединяться
- **Серверное управление** — создание чатов и добавление участников из кода приложения
- **Бизнес-правила** — ограничения на количество чатов, доступ к чужим чатам и т.д.

---

### Что нужно реализовать

Конкретные бизнес-правила для этого тестового задания:

#### Чаты между пользователями (1-on-1)

- Alice может начать чат с любым пользователем
- Никто не может первым начать чат с Alice (только она инициирует)
- Пользователи не могут присоединяться к чужим 1-on-1 чатам
- Между двумя пользователями может быть не больше 1 чата

#### Чаты с поддержкой (Support)

- Админ может начать чат с любым пользователем (это "чат поддержки")
- У каждого пользователя может быть **только один** активный чат с поддержкой
- Любой админ может присоединиться к любому чату поддержки

#### Интерфейс пользователя

- Список своих чатов (показывать счётчик непрочитанных, если есть)
- Окно чата с историей сообщений
- Отправка сообщений

#### Интерфейс админа

- Просмотр всех чатов
- Возможность присоединиться к чату поддержки
- Кнопка "Отправить системное сообщение" (эмуляция системного события)

---

### Чего НЕ нужно делать

- Загрузка файлов (только подготовить структуру)
- Индикатор "печатает..."
- Push-уведомления
- Полнотекстовый поиск

## Полезная информация

### Команды

```bash
bin/dev           # запуск приложения
bundle exec rspec # запуск тестов
```

---

## Ссылки

- [Twilio Conversations API](https://www.twilio.com/docs/conversations)
- [Action Cable Guide](https://guides.rubyonrails.org/action_cable_overview.html)
- [Turbo Handbook](https://turbo.hotwired.dev/handbook/introduction)
